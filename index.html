<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buster's Command Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: #e0e0e0;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 2px solid #40e0d0;
        }

        h1 {
            font-size: 2.5em;
            color: #40e0d0;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #a0a0b0;
            font-size: 0.95em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(64, 224, 208, 0.05);
            border: 1px solid rgba(64, 224, 208, 0.2);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: rgba(64, 224, 208, 0.5);
            background: rgba(64, 224, 208, 0.1);
        }

        .stat-label {
            color: #a0a0b0;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2em;
            color: #40e0d0;
            font-weight: bold;
        }

        .stat-subtext {
            color: #707080;
            font-size: 0.8em;
            margin-top: 8px;
        }

        .project-section {
            margin-bottom: 40px;
        }

        .project-title {
            font-size: 1.8em;
            color: #40e0d0;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(64, 224, 208, 0.3);
        }

        .tasks-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 1.3em;
            color: #e0e0e0;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(64, 224, 208, 0.2);
        }

        .task-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(64, 224, 208, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(64, 224, 208, 0.3);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .task-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #e0e0e0;
            flex: 1;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            white-space: nowrap;
        }

        .priority-critical {
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .priority-high {
            background: rgba(255, 152, 0, 0.3);
            color: #ff9800;
            border: 1px solid #ff9800;
        }

        .priority-medium {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .priority-low {
            background: rgba(76, 175, 80, 0.2);
            color: #90c090;
            border: 1px solid #90c090;
        }

        .task-meta {
            display: flex;
            gap: 16px;
            font-size: 0.9em;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #a0a0b0;
        }

        .meta-label {
            color: #707080;
        }

        .progress-bar {
            height: 8px;
            background: rgba(64, 224, 208, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #40e0d0, #00bfff);
            transition: width 0.3s ease;
        }

        .token-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 0.9em;
        }

        .token-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 2px solid #40e0d0;
        }

        .token-label {
            color: #a0a0b0;
            font-size: 0.8em;
        }

        .token-value {
            color: #40e0d0;
            font-weight: 600;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(64, 224, 208, 0.1);
            border: 1px solid rgba(64, 224, 208, 0.3);
            color: #40e0d0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: rgba(64, 224, 208, 0.2);
            border-color: rgba(64, 224, 208, 0.6);
        }

        .filter-btn.active {
            background: rgba(64, 224, 208, 0.3);
            border-color: #40e0d0;
        }

        .cost-section {
            background: rgba(255, 165, 0, 0.08);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 32px;
        }

        .cost-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .cost-title {
            font-size: 1.4em;
            color: #ffb700;
            font-weight: bold;
        }

        .model-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .model-btn {
            padding: 8px 16px;
            background: rgba(64, 224, 208, 0.1);
            border: 1px solid rgba(64, 224, 208, 0.3);
            color: #40e0d0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .model-btn:hover {
            background: rgba(64, 224, 208, 0.2);
            border-color: #40e0d0;
        }

        .model-btn.active {
            background: #40e0d0;
            color: #1e1e2e;
            border-color: #40e0d0;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .cost-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 165, 0, 0.2);
            border-radius: 6px;
            padding: 16px;
        }

        .cost-label {
            color: #a0a0b0;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cost-value {
            font-size: 1.8em;
            color: #ffb700;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .cost-subtext {
            color: #707080;
            font-size: 0.8em;
        }

        .budget-alert {
            background: rgba(255, 71, 87, 0.15);
            border: 1px solid rgba(255, 71, 87, 0.5);
            border-radius: 6px;
            padding: 12px 16px;
            color: #ff6b7a;
            font-size: 0.9em;
            margin-top: 12px;
            display: none;
        }

        .budget-alert.show {
            display: block;
        }

        .session-costs {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }

        .session-cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .session-cost-item:last-child {
            margin-bottom: 0;
        }

        .session-name {
            color: #e0e0e0;
            font-weight: 500;
        }

        .session-cost {
            color: #ffb700;
            font-weight: bold;
        }

        .session-model {
            color: #707080;
            font-size: 0.8em;
        }

        .last-updated {
            text-align: center;
            color: #707080;
            font-size: 0.8em;
            margin-top: 32px;
            padding-top: 20px;
            border-top: 1px solid rgba(64, 224, 208, 0.1);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .task-header {
                flex-direction: column;
            }

            .priority-badge {
                align-self: flex-start;
            }

            .token-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß Buster's Command Center</h1>
            <p class="subtitle">Projects ‚Ä¢ Tasks ‚Ä¢ Progress ‚Ä¢ Token Usage</p>
        </header>

        <!-- Cost Tracking Section -->
        <div class="cost-section">
            <div class="cost-header">
                <div class="cost-title">üí∞ Cost Monitoring</div>
                <div class="model-selector" id="modelSelector">
                    <button class="model-btn active" data-model="haiku">‚ö° Haiku</button>
                    <button class="model-btn" data-model="sonnet">‚öôÔ∏è Sonnet</button>
                    <button class="model-btn" data-model="opus">üß† Opus</button>
                </div>
            </div>

            <div class="cost-grid">
                <div class="cost-card">
                    <div class="cost-label">Current Session Cost</div>
                    <div class="cost-value" id="currentCost">$0.00</div>
                    <div class="cost-subtext" id="currentModel">Using Haiku</div>
                </div>
                <div class="cost-card">
                    <div class="cost-label">Estimated Daily Usage</div>
                    <div class="cost-value" id="dailyUsage">$0.00</div>
                    <div class="cost-subtext">Run rate projection</div>
                </div>
                <div class="cost-card">
                    <div class="cost-label">Daily Budget</div>
                    <div class="cost-value" id="dailyBudget">$10.00</div>
                    <div class="cost-subtext" id="budgetStatus">On track</div>
                </div>
                <div class="cost-card">
                    <div class="cost-label">Total Tokens</div>
                    <div class="cost-value" id="totalCostTokens">0</div>
                    <div class="cost-subtext">Input + Output</div>
                </div>
            </div>

            <div class="budget-alert" id="budgetAlert">
                ‚ö†Ô∏è Budget Alert: Current usage rate exceeds daily budget limit!
            </div>

            <div class="session-costs">
                <div style="color: #a0a0b0; font-weight: 600; margin-bottom: 12px; font-size: 0.9em;">Session Breakdown</div>
                <div id="sessionCostsList"></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Tasks</div>
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-subtext"><span id="activeTasks">0</span> active</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Token Usage (All Sessions)</div>
                <div class="stat-value" id="tokenUsage">0</div>
                <div class="stat-subtext" id="modelDisplay">Haiku model</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Estimated to Complete</div>
                <div class="stat-value" id="estimatedTokens">0</div>
                <div class="stat-subtext">Based on active tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Overall Progress</div>
                <div class="stat-value" id="overallProgress">0%</div>
                <div class="stat-subtext"><span id="completedTasks">0</span> / <span id="totalTasksSmall">0</span></div>
            </div>
        </div>

        <div id="projectsContainer"></div>

        <div class="last-updated">
            Last updated: <span id="lastUpdated">Never</span>
            <br>
            <small>Data pulled from tracker.json ‚Äî refresh the page for latest</small>
        </div>
    </div>

    <script>
        let currentModel = 'haiku';
        let dashboardData = null;

        async function loadData() {
            try {
                const response = await fetch('./tracker.json');
                dashboardData = await response.json();
                renderDashboard(dashboardData);
                setupModelSelector();
            } catch (e) {
                console.error('Failed to load tracker.json:', e);
                document.body.innerHTML += '<p style="text-align: center; color: red; margin-top: 40px;">Failed to load dashboard data. Make sure tracker.json exists.</p>';
            }
        }

        function formatCost(tokens, model = 'haiku') {
            const models = dashboardData?.metadata?.models || {
                haiku: { inputCost: 0.80, outputCost: 4.00 },
                sonnet: { inputCost: 3.00, outputCost: 15.00 },
                opus: { inputCost: 15.00, outputCost: 75.00 }
            };

            const pricing = models[model];
            // Assume 40% input, 60% output on average
            const inputTokens = Math.round(tokens * 0.4);
            const outputTokens = Math.round(tokens * 0.6);

            const inputCost = (inputTokens / 1_000_000) * pricing.inputCost;
            const outputCost = (outputTokens / 1_000_000) * pricing.outputCost;
            return inputCost + outputCost;
        }

        function setupModelSelector() {
            const buttons = document.querySelectorAll('.model-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentModel = btn.dataset.model;
                    renderCostSection(dashboardData);
                });
            });
        }

        function renderCostSection(data) {
            const selectedModelData = data.metadata.models[currentModel];
            const totalSessions = data.sessions || {};
            
            let totalCost = 0;
            let totalTokens = 0;
            const sessionsList = [];

            // Calculate costs for all sessions
            Object.entries(totalSessions).forEach(([key, session]) => {
                const tokens = session.currentTokens || 0;
                const cost = formatCost(tokens, currentModel);
                totalCost += cost;
                totalTokens += tokens;
                
                sessionsList.push({
                    name: session.name,
                    tokens,
                    cost,
                    model: currentModel
                });
            });

            // Estimate daily usage (assuming current rate continues)
            const dailyUsage = totalCost;
            const dailyBudget = data.costTracking?.dailyBudget || 10.00;
            const isOverBudget = dailyUsage > dailyBudget;

            // Update cost displays
            document.getElementById('currentCost').textContent = `$${totalCost.toFixed(4)}`;
            document.getElementById('currentModel').textContent = `Using ${selectedModelData.displayName}`;
            document.getElementById('dailyUsage').textContent = `$${dailyUsage.toFixed(4)}`;
            document.getElementById('dailyBudget').textContent = `$${dailyBudget.toFixed(2)}`;
            document.getElementById('totalCostTokens').textContent = totalTokens.toLocaleString();
            document.getElementById('modelDisplay').textContent = `${selectedModelData.displayName} model`;
            
            // Budget alert
            const budgetAlert = document.getElementById('budgetAlert');
            if (isOverBudget) {
                budgetAlert.classList.add('show');
                document.getElementById('budgetStatus').textContent = '‚ö†Ô∏è Over budget!';
                document.getElementById('budgetStatus').style.color = '#ff6b7a';
            } else {
                budgetAlert.classList.remove('show');
                const percentUsed = Math.round((dailyUsage / dailyBudget) * 100);
                document.getElementById('budgetStatus').textContent = `${percentUsed}% used`;
                document.getElementById('budgetStatus').style.color = '#707080';
            }

            // Render session costs
            const sessionCostsList = document.getElementById('sessionCostsList');
            sessionCostsList.innerHTML = sessionsList
                .filter(s => s.tokens > 0)
                .map(s => `
                    <div class="session-cost-item">
                        <div>
                            <div class="session-name">${s.name}</div>
                            <div class="session-model">${s.tokens.toLocaleString()} tokens</div>
                        </div>
                        <div class="session-cost">$${s.cost.toFixed(4)}</div>
                    </div>
                `)
                .join('');

            if (sessionsList.filter(s => s.tokens > 0).length === 0) {
                sessionCostsList.innerHTML = '<div class="session-cost-item"><div class="session-name">No active sessions</div></div>';
            }
        }

        function renderDashboard(data) {
            let totalTasks = 0;
            let activeTasks = 0;
            let completedTasks = 0;
            let totalTokens = 0;
            let totalEstimated = 0;

            const projectsContainer = document.getElementById('projectsContainer');
            projectsContainer.innerHTML = '';

            // Process each project
            Object.entries(data.projects || {}).forEach(([key, project]) => {
                if (!project.tasks || project.tasks.length === 0) return;

                totalTasks += project.tasks.length;
                
                const completed = project.tasks.filter(t => t.status === 'done').length;
                const active = project.tasks.filter(t => t.status === 'in progress').length;
                const estimated = project.tasks
                    .filter(t => t.status !== 'done')
                    .reduce((sum, t) => sum + (t.estimatedTokens * (100 - (t.progress || 0)) / 100), 0);

                completedTasks += completed;
                activeTasks += active;
                totalEstimated += estimated;

                const projectHTML = `
                    <div class="project-section">
                        <h2 class="project-title">${project.emoji || 'üìã'} ${project.name}</h2>
                        
                        <div class="tasks-section">
                            <div class="filter-buttons">
                                <button class="filter-btn active">All (${project.tasks.length})</button>
                                <button class="filter-btn">${active} In Progress</button>
                                <button class="filter-btn">${completed} Done</button>
                            </div>
                            <div class="task-list">
                                ${project.tasks.map(task => `
                                    <div class="task-card">
                                        <div class="task-header">
                                            <div class="task-title">${getStatusEmoji(task.status)} ${task.title}</div>
                                            ${task.priority ? `<div class="priority-badge priority-${task.priority}">${task.priority.toUpperCase()}</div>` : ''}
                                        </div>
                                        <div class="task-meta">
                                            <div class="meta-item"><span class="meta-label">Status:</span> <span>${task.status}</span></div>
                                            <div class="meta-item"><span class="meta-label">Progress:</span> <span>${task.progress || 0}%</span></div>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${task.progress || 0}%"></div>
                                        </div>
                                        ${task.description ? `<p style="color: #a0a0b0; font-size: 0.9em; margin-bottom: 12px;">${task.description}</p>` : ''}
                                        ${task.estimatedTokens ? `
                                            <div class="token-info">
                                                <div class="token-item">
                                                    <div class="token-label">Est. Tokens</div>
                                                    <div class="token-value">${task.estimatedTokens.toLocaleString()}</div>
                                                </div>
                                                <div class="token-item">
                                                    <div class="token-label">Per % Complete</div>
                                                    <div class="token-value">${Math.round(task.estimatedTokens / 100).toLocaleString()}</div>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                projectsContainer.innerHTML += projectHTML;
            });

            // Count tokens across sessions
            if (data.sessions) {
                Object.values(data.sessions).forEach(session => {
                    totalTokens += session.currentTokens || 0;
                });
            }

            // Update stats
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('activeTasks').textContent = activeTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('totalTasksSmall').textContent = totalTasks;
            document.getElementById('overallProgress').textContent = totalTasks > 0 ? `${Math.round(completedTasks / totalTasks * 100)}%` : '0%';
            document.getElementById('tokenUsage').textContent = totalTokens.toLocaleString();
            document.getElementById('estimatedTokens').textContent = Math.round(totalEstimated).toLocaleString();
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            // Render cost section with current model
            renderCostSection(data);
        }

        function getStatusEmoji(status) {
            const emojis = {
                'todo': 'üìã',
                'in progress': '‚öôÔ∏è',
                'in review': 'üëÄ',
                'done': '‚úÖ'
            };
            return emojis[status] || '‚ùì';
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
